library(readxl)
library(tidyverse)
library("basedosdados")

# Indicador Proporcao de Funcionarios em C&T (i512)

# ------------------------------------------------------------------
# PASSO 0: preliminares
# ------------------------------------------------------------------

# Definir projeto no Google Cloud
set_billing_id("workshop-teste-322616")

# definimos uma fun√ß√£o para desvio padrao populacional para ser usada mais a frente no c√≥digo
sdp <- function(x) {
  sd(x)*(sqrt((length(x)-1)/length(x)))
}

# importamos tabela com dados dos municipios mais populosos
top100_mun_cod <- read.csv("top100_mun_cod.csv", stringsAsFactors = FALSE)
top100_mun_cod <- top100_mun_cod %>% 
                  transform(id_municipio = as.character(id_municipio))
# ------------------------------------------------------------------
# PASSO 1: obter trabalhadores em ocupacoes C&T
# ------------------------------------------------------------------

# importamos tabela com ocupacoes de interesse de acordo com CBO (2002)
# essa tabela nao e usada diretamente neste codigo, mas e usada para auxiliar a criacao da query no Banco dos Dados
ocupacoes_cet <- read_excel("C:/Users/User/OneDrive/Documentos/ICE 2021/d5 InovaÁ„o/sd51 Inputs/i512/CBO2002 - OcupaÁ„o Subgrupo Principal 20 21 30 31 39 72 73.xlsx")
ocupacoes_cet$cod_cet = as.character(ocupacoes_cet$cod_cet)

# consultamos na RAIS os vinculos de trabalho do ano 2019
query <- "SELECT valor_remun_media_nominal, ano, id_municipio, cbo_2002 
FROM `basedosdados.br_me_rais.microdados_vinculos` 
WHERE ano = 2019
AND cbo_2002 IN ('201105','201110','201115','201205','201210','201215','201220','201225','202105','202110'
,'202115','202120','203005','203010','203015','203020','203025','203105','203110','203115'
,'203120','203125','203205','203210','203215','203220','203225','203230','203305','203310'
,'203315','203320','203405','203410','203415','203420','203505','203510','203515','203520'
,'203525','204105','211105','211110','211115','211120','211205','211210','211215','212205'
,'212210','212215','212305','212310','212315','212320','212405','212410','212415','212420'
,'212425','212430','213105','213110','213115','213120','213125','213130','213135','213140'
,'213145','213150','213155','213160','213165','213170','213175','213205','213210','213215'
,'213305','213310','213315','213405','213410','213415','213420','213425','213430','213435'
,'213440','214005','214010','214105','214110','214115','214120','214125','214130','214205'
,'214210','214215','214220','214225','214230','214235','214240','214245','214250','214255'
,'214260','214265','214270','214280','214305','214310','214315','214320','214325','214330'
,'214335','214340','214345','214350','214360','214365','214370','214405','214410','214415'
,'214420','214425','214430','214435','214505','214510','214515','214520','214525','214530'
,'214535','214605','214610','214615','214705','214710','214715','214720','214725','214730'
,'214735','214740','214745','214750','214805','214810','214905','214910','214915','214920'
,'214925','214930','214935','214940','214945','215105','215110','215115','215120','215125'
,'215130','215135','215140','215145','215150','215205','215210','215215','215220','215305'
,'215310','215315','300105','300110','300305','301105','301110','301115','301205','311105'
,'311110','311115','311205','311305','311405','311410','311505','311510','311515','311520'
,'311605','311610','311615','311620','311625','311705','311710','311715','311720','311725'
,'312105','312205','312210','312305','312310','312315','312320','313105','313110','313115'
,'313120','313125','313130','313205','313210','313215','313220','313305','313310','313315'
,'313320','313405','313410','313415','313505','314105','314110','314115','314120','314125'
,'314205','314210','314305','314310','314315','314405','314410','314610','314615','314620'
,'314625','314705','314710','314715','314720','314725','314730','314805','314810','314815'
,'314825','314830','314835','314840','314845','316105','316110','316115','316120','316305'
,'316310','316315','316320','316325','316330','316335','316340','317105','317110','317115'
,'317120','317205','317210','318005','318010','318015','318105','318110','318115','318120'
,'318205','318210','318215','318305','318310','318405','318410','318415','318420','318425'
,'318430','318505','318510','318605','318610','318705','318710','318805','318810','318815'
,'319105','319110','319205','391105','391110','391115','391120','391125','391130','391135'
,'391140','391145','391205','391210','391215','391220','391225','391230','395105','395110'
,'720105','720110','720115','720120','720125','720130','720135','720140','720145','720150'
,'720155','720160','720205','720210','720215','720220','721105','721110','721115','721205'
,'721210','721215','721220','721225','721305','721310','721315','721320','721325','721405'
,'721410','721415','721420','721425','721430','722105','722110','722115','722205','722210'
,'722215','722220','722225','722230','722235','722305','722310','722315','722320','722325'
,'722330','722405','722410','722415','723105','723110','723115','723120','723125','723205'
,'723210','723215','723220','723225','723230','723235','723240','723305','723310','723315'
,'723320','723325','723330','724105','724110','724115','724120','724125','724130','724135'
,'724205','724210','724215','724220','724225','724230','724305','724310','724315','724320'
,'724325','724405','724410','724415','724420','724425','724430','724435','724440','724505'
,'724510','724515','724605','724610','725005','725010','725015','725020','725025','725105'
,'725205','725210','725215','725220','725225','725305','725310','725315','725320','725405'
,'725410','725415','725420','725505','725510','725605','725610','725705','730105','731105'
,'731110','731115','731120','731125','731130','731135','731140','731145','731150','731155'
,'731160','731165','731170','731175','731180','731205','731305','731310','731315','731320'
,'731325','731330','732105','732110','732115','732120','732125','732130','732135','732140')
AND id_municipio IN ('3550308','3304557','5300108','2927408','2304400','3106200','1302603','4106902','2611606','5208707','1501402','4314902','3518800'
,'3509502','2111300','3304904','2704302','3301702','5002704','2408102','2211001','3548708','3303500','2507507','3549904','3547809'
,'3543402','2607901','3534401','3170206','3552205','3118601','2800308','2910800','5103403','4209102','5201405','4113700','3136702'
,'1100205','1500800','3205002','4305108','3303302','3300456','1600303','3301009','4205407','3205200','3529401','3305109','3549805'
,'3530607','3106705','3548500','4115200','3513801','3525904','1400100','3143302','1200401','2504009','3538709','3510609','2609600'
,'5201108','3201308','3506003','3523107','3551009','3205309','2604106','2303709','4202404','3516200','4119905','2611101','4304606'
,'4314407','2933307','3154606','3170107','2610707','4104808','3541000','4125506','3518701','3554102','3526902','3303906','1506807'
,'1721000','2905701','2408003','3552502','3552809','5108402','3552403','4316907','4309209', '1504208')"
ocupacoes_cet <- read_sql(query)

ocupacoes_cet_ice <- ocupacoes_cet %>% count(id_municipio, name = "n_cet") %>%
                      inner_join(top100_mun_cod, by = 'id_municipio') %>%
                      select(id_municipio, sigla_uf, nome, n_cet) %>%
                      arrange(desc(n_cet))

# ------------------------------------------------------------------
# PASSO 2: obter total de trabalhadores
# ------------------------------------------------------------------

# obtemos na RAIS total de trabalhadores em cada municipio de interesse
query <- "SELECT id_municipio, count(*) 
FROM `basedosdados.br_me_rais.microdados_vinculos` 
WHERE ano = 2019
AND id_municipio IN ('3550308','3304557','5300108','2927408','2304400','3106200','1302603','4106902','2611606','5208707','1501402','4314902','3518800'
,'3509502','2111300','3304904','2704302','3301702','5002704','2408102','2211001','3548708','3303500','2507507','3549904','3547809'
,'3543402','2607901','3534401','3170206','3552205','3118601','2800308','2910800','5103403','4209102','5201405','4113700','3136702'
,'1100205','1500800','3205002','4305108','3303302','3300456','1600303','3301009','4205407','3205200','3529401','3305109','3549805'
,'3530607','3106705','3548500','4115200','3513801','3525904','1400100','3143302','1200401','2504009','3538709','3510609','2609600'
,'5201108','3201308','3506003','3523107','3551009','3205309','2604106','2303709','4202404','3516200','4119905','2611101','4304606'
,'4314407','2933307','3154606','3170107','2610707','4104808','3541000','4125506','3518701','3554102','3526902','3303906','1506807'
,'1721000','2905701','2408003','3552502','3552809','5108402','3552403','4316907','4309209', '1504208')
GROUP BY id_municipio"
trabalhadores <- read_sql(query, page_size = 300000)

trabalhadores_ice <- trabalhadores %>% inner_join(top100_mun_cod, by = "id_municipio") %>%
                  rename(trabalhadores = f0_) %>%
                  select(id_municipio, nome, sigla_uf, trabalhadores) %>%
                  arrange(desc(trabalhadores))

# ------------------------------------------------------------------
# PASSO 3: calcular indice
# ------------------------------------------------------------------

# calcular e padronizar indice i512
i512 <- trabalhadores_ice %>% 
        inner_join(ocupacoes_cet_ice, by = c('id_municipio','nome', 'sigla_uf')) %>%
        mutate(i512 = n_cet/trabalhadores) %>%
        mutate(i512_pad = (i512 - mean(i512))/sdp(i512)) %>%
        arrange(desc(i512_pad)) %>%
        select(id_municipio, nome, sigla_uf, i512, i512_pad)

# exportar arquivo
write.csv(i512, "i512.csv", row.names = FALSE)  
